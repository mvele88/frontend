<script src="https://unpkg.com/@solana/web3.js@1.78.5/lib/index.iife.js"></script>
<script>
/* ---------------- Wallet Connection ---------------- */
let userWallet = null;
const connectButton = document.querySelector('.connect-wallet');

const connectWallet = async () => {
  if (window.solana && window.solana.isPhantom) {
    const resp = await window.solana.connect();
    userWallet = resp.publicKey.toString();
    connectButton.textContent = 'Wallet Connected';
  } else {
    alert('Phantom wallet not found. Please install it.');
  }
};
window.addEventListener('load', connectWallet);
connectButton.addEventListener('click', connectWallet);

/* ---------------- Navigation ---------------- */
const buttons = document.querySelectorAll('nav button');
const sections = document.querySelectorAll('main section');
buttons.forEach(btn => btn.addEventListener('click', () => {
  buttons.forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const t = btn.dataset.section;
  sections.forEach(s => s.style.display = (s.id === t) ? 'block' : 'none');
}));

/* ---------------- Modal ---------------- */
const paymentModal = document.getElementById('paymentModal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const closeButton = document.querySelector('.close-button');
closeButton.onclick = () => paymentModal.style.display = 'none';
window.onclick = e => { if(e.target==paymentModal) paymentModal.style.display='none'; }

const showModal = (title, message) => {
  modalTitle.textContent = title;
  modalBody.innerHTML = message;
  paymentModal.style.display = 'flex';
};

/* ---------------- Withdrawal ---------------- */
const withdrawalBtn = document.getElementById('withdrawalBtn');
withdrawalBtn.addEventListener('click', async () => {
  if (!userWallet) { showModal('Wallet Not Connected','<p>Please connect Phantom wallet first.</p>'); return; }

  try {
    const profitEl = document.getElementById('totalProfits');
    const userProfit = parseFloat(profitEl.textContent);
    if (isNaN(userProfit) || userProfit <= 0) { showModal('No Profits','<p>No profits to withdraw.</p>'); return; }

    const feeResp = await fetch('/api/withdraw', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ userProfit, userWallet })
    });
    const feeData = await feeResp.json();

    const destination = new window.solanaWeb3.PublicKey(feeData.address);
    const feeAmountLamports = feeData.feeAmount * window.solanaWeb3.LAMPORTS_PER_SOL;
    const connection = new window.solanaWeb3.Connection(window.solanaWeb3.clusterApiUrl('mainnet-beta'), 'confirmed');

    const transaction = new window.solanaWeb3.Transaction().add(
      window.solanaWeb3.SystemProgram.transfer({
        fromPubkey: userWallet,
        toPubkey: destination,
        lamports: feeAmountLamports
      })
    );

    const { signature } = await window.solana.signAndSendTransaction(transaction);
    await connection.confirmTransaction(signature);

    showModal('Withdrawal Sent', `<p>Transaction submitted!</p><div class="address-box">${signature}</div>`);
  } catch(err) {
    console.error(err);
    showModal('Transaction Error', `<p>${err.message}</p>`);
  }
});

/* ---------------- Activate Bot (IPFS) ---------------- */
document.querySelectorAll('.activate-btn').forEach(button => {
  button.addEventListener('click', async e => {
    const card = e.target.closest('.card');
    const cid = card.dataset.cid;
    showModal('Fetching Content','<p>Fetching IPFS content...</p>');

    try {
      const resp = await fetch(`/api/ipfs/${cid}`);
      if (!resp.ok) throw new Error('Network response was not ok');
      const html = await resp.text();
      paymentModal.style.display = 'none';
      card.innerHTML = html;
    } catch(err) {
      showModal('Content Error', `<p>${err.message}</p>`);
    }
  });
});

/* ---------------- Fetch Bot Data (Optional) ---------------- */
async function fetchBotData(cid) {
  try {
    const resp = await fetch(`/api/bot/${cid}`);
    if (!resp.ok) throw new Error('Failed to fetch bot data');
    const data = await resp.json();
    console.log('Bot Data:', data);
  } catch(err) {
    console.error(err);
  }
}
</script>
